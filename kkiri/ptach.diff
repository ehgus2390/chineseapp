import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:provider/provider.dart';

import 'firebase_options.dart';
import 'providers/auth_provider.dart';
import 'providers/chat_provider.dart';
import 'providers/match_provider.dart';
import 'providers/location_provider.dart';

import 'screens/auth/sign_in_screen.dart';
import 'screens/home_screen.dart';
import 'screens/map/nearby_map_screen.dart';
import 'screens/settings/settings_screen.dart';
import 'screens/tabs/chat_list_screen.dart';
import 'screens/tabs/discover_screen.dart';
import 'screens/tabs/matches_screen.dart';
import 'screens/tabs/profile_screen.dart'; // (ì‚¬ìš© ì•ˆ í•˜ë©´ ì§€ì›Œë„ ë¨)

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Firebase init (ì•ˆì „í•˜ê²Œ try/catch ê¶Œì¥)
  try {
    final options = DefaultFirebaseOptions.currentPlatform;
    if (options != null) {
      await Firebase.initializeApp(options: options);
    } else {
      await Firebase.initializeApp();
    }
  } catch (e, s) {
    debugPrint('ğŸ”¥ Firebase init error: $e');
    debugPrintStack(stackTrace: s);
  }

  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => AuthProvider()),
        ChangeNotifierProvider(create: (_) => ChatProvider()),
        ChangeNotifierProvider(create: (_) => MatchProvider()),
        
      ],
      child: const KkiriApp(),
    ),
  );
}

/// âœ… í•µì‹¬: GoRouterëŠ” build() ì•ˆì—ì„œ ë§Œë“¤ì§€ ë§ê³ , initStateì—ì„œ 1íšŒ ìƒì„±
class KkiriApp extends StatefulWidget {
  const KkiriApp({super.key});

  @override
  State<KkiriApp> createState() => _KkiriAppState();
}

class _KkiriAppState extends State<KkiriApp> {
  late final GoRouter _router;

  @override
  void initState() {
    super.initState();

    // âœ… watch() ì“°ë©´ ì•ˆ ë¨. initStateì—ì„œëŠ” read()ë§Œ.
    final auth = context.read<AuthProvider>();

    _router = GoRouter(
      initialLocation: '/home/discover',
      refreshListenable: auth,

      // (ì„ íƒ) ë””ë²„ê·¸ ë¡œê·¸ ë³´ê³  ì‹¶ìœ¼ë©´
      // debugLogDiagnostics: true,

      redirect: (context, state) {
        // âœ… redirectëŠ” ì•± ë¶€íŒ… ì§í›„ì—ë„ í˜¸ì¶œë  ìˆ˜ ìˆìŒ
        final isLoggedIn = auth.currentUser != null;
        final loggingIn = state.matchedLocation == '/sign-in';

        if (!isLoggedIn) {
          return loggingIn ? null : '/sign-in';
        }

        if (loggingIn) {
          return '/home/discover';
        }

        return null;
      },

      routes: [
        GoRoute(
          path: '/sign-in',
          builder: (_, __) => const SignInScreen(),
        ),

        ShellRoute(
          builder: (context, state, child) => HomeScreen(child: child),
          routes: [
            GoRoute(
              path: '/home/discover',
              builder: (_, __) => const DiscoverScreen(),
            ),
            GoRoute(
              path: '/home/matches',
              builder: (_, __) => const MatchesScreen(),
            ),
            GoRoute(
              path: '/home/chat',
              builder: (_, __) => const ChatListScreen(),
            ),
            GoRoute(
              path: '/home/map',
              builder: (_, __) => const NearbyMapScreen(),
            ),
            GoRoute(
              path: '/home/settings',
              builder: (_, __) => const SettingsScreen(),
            ),

            // ProfilePageë¥¼ ì‹¤ì œë¡œ ì“°ë©´ ì—¬ê¸° ì¶”ê°€í•˜ê³ ,
            // ì•ˆ ì“°ë©´ importë¶€í„° ì§€ìš°ë©´ ë¨.
            // GoRoute(
            //   path: '/home/profile',
            //   builder: (_, __) => const ProfilePage(),
            // ),
          ],
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: 'HeartLink',
      theme: ThemeData(
        useMaterial3: true,
        colorSchemeSeed: Colors.pinkAccent,
      ),
      routerConfig: _router,
    );
  }
}




# diff --git a/kkiri/lib/main.dart b/kkiri/lib/main.dart
# index 1c06e3d9c1edde1c923249236df7c5f6a2a2366a..296df2376d37dd343620bc71b3fc4089153f7fa3 100644
# --- a/kkiri/lib/main.dart
# +++ b/kkiri/lib/main.dart
# @@ -1,84 +1,84 @@
#  import 'package:firebase_core/firebase_core.dart';
#  import 'package:flutter/material.dart';
#  import 'package:go_router/go_router.dart';
#  import 'package:provider/provider.dart';
 
#  import 'firebase_options.dart';
#  import 'providers/auth_provider.dart';
#  import 'providers/chat_provider.dart';
# -import 'providers/friends_provider.dart';
# +import 'providers/match_provider.dart';
#  import 'providers/location_provider.dart';
#  import 'screens/auth/sign_in_screen.dart';
#  import 'screens/home_screen.dart';
#  import 'screens/map/nearby_map_screen.dart';
#  import 'screens/settings/settings_screen.dart';
# -import 'screens/tabs/board_screen.dart';
#  import 'screens/tabs/chat_list_screen.dart';
# -import 'screens/tabs/friends_screen.dart';
# +import 'screens/tabs/discover_screen.dart';
# +import 'screens/tabs/matches_screen.dart';
#  import 'screens/tabs/profile_screen.dart';
 

#  Future<void> main() async {
#    WidgetsFlutterBinding.ensureInitialized();
#    final options = DefaultFirebaseOptions.currentPlatform;
#    if (options != null) {
#      await Firebase.initializeApp(options: options);
#    } else {
#      await Firebase.initializeApp();
#    }
 
#    runApp(
#      MultiProvider(
#        providers: [
#          ChangeNotifierProvider(create: (_) => AuthProvider()),
#          ChangeNotifierProvider(create: (_) => ChatProvider()),
# -        ChangeNotifierProvider(create: (_) => FriendsProvider()),
# +        ChangeNotifierProvider(create: (_) => MatchProvider()),
#          ChangeNotifierProvider(create: (_) => LocationProvider()),
#        ],
#        child: const KkiriApp(),
#      ),
#    );
#  }
 
#  class KkiriApp extends StatelessWidget {
#    const KkiriApp({super.key});
 
#    @override
#    Widget build(BuildContext context) {
#      final auth = context.watch<AuthProvider>();
#      final router = GoRouter(
# -      initialLocation: '/home/chat',
# +      initialLocation: '/home/discover',
#        refreshListenable: auth,
#        redirect: (context, state) {
#          final isLoggedIn = auth.currentUser != null;
#          final loggingIn = state.matchedLocation == '/sign-in';
#          if (!isLoggedIn) {
#            return loggingIn ? null : '/sign-in';
#          }
#          if (loggingIn) {
# -          return '/home/chat';
# +          return '/home/discover';
#          }
#          return null;
#        },
#        routes: [
#          GoRoute(path: '/sign-in', builder: (_, __) => const SignInScreen()),
#          ShellRoute(
#            builder: (context, state, child) => HomeScreen(child: child),
#            routes: [
# -            GoRoute(path: '/home/profile', builder: (_, __) => const ProfilePage()),
# -            GoRoute(path: '/home/friends', builder: (_, __) => const FriendsScreen()),
# +            GoRoute(path: '/home/discover', builder: (_, __) => const DiscoverScreen()),
# +            GoRoute(path: '/home/matches', builder: (_, __) => const MatchesScreen()),
#              GoRoute(path: '/home/chat', builder: (_, __) => const ChatListScreen()),
#              GoRoute(path: '/home/map', builder: (_, __) => const NearbyMapScreen()),
# -            GoRoute(path: '/home/board', builder: (_, __) => const BoardScreen()),
# +
#              GoRoute(path: '/home/settings', builder: (_, __) => const SettingsScreen()),
#            ],
#          ),
#        ],
#      );
 
#      return MaterialApp.router(
# -      title: 'Kkiri',
# -      theme: ThemeData(useMaterial3: true, colorSchemeSeed: Colors.blueAccent),
# +      title: 'HeartLink',
# +      theme: ThemeData(useMaterial3: true, colorSchemeSeed: Colors.pinkAccent),
#        routerConfig: router,
#      );
#    }
#  }
